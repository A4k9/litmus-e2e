#!/bin/bash
set -e
path=$(pwd)
echo $SDK_TOKEN > key.json
gcloud auth activate-service-account --key-file=key.json
gcloud config set project ${PROJECT_ID}
export GOOGLE_APPLICATION_CREDENTIALS="$path/key.json"
export GCP_SERVICE_ACCOUNT_FILE="$path/key.json"
export GKEUSER=`echo $GKE_USER`

git clone https://github.com/litmuschaos/litmus-e2e.git -b generic
cd litmus-e2e/build/gitlab/stages/

sudo truncate -s 0 ~/logs/clusters
sudo truncate -s 0 ~/logs/zone

echo "creating cluster"

sudo ansible-playbook create-gke-cluster.yml -vv --extra-vars "project=${PROJECT_NAME}"
sudo mkdir $path/.kube
sudo cat ~/.kube/config > $path/.kube/config
sudo cat ~/.kube/config > $path/.kube/admin.conf
sudo cat ~/logs/clusters > $path/.kube/clusters
sudo cat ~/logs/zone > $path/.kube/zone

sudo kubectl get nodes
